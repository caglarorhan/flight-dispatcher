name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-binaries:
    name: Build binaries (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            targets: node18-linux-x64,node18-linux-arm64,node18-macos-x64,node18-macos-arm64,node18-win-x64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Build binaries
        shell: bash
        run: |
          VERSION="${{ github.ref_name }}"
          mkdir -p binaries
          PKG=./node_modules/.bin/pkg
          $PKG . --compress GZip --target node18-win-x64    --output "binaries/flight-dispatcher-${VERSION}-win-x64.exe"
          $PKG . --compress GZip --target node18-macos-x64  --output "binaries/flight-dispatcher-${VERSION}-macos-x64"
          $PKG . --compress GZip --target node18-macos-arm64 --output "binaries/flight-dispatcher-${VERSION}-macos-arm64"
          $PKG . --compress GZip --target node18-linux-x64  --output "binaries/flight-dispatcher-${VERSION}-linux-x64"
          $PKG . --compress GZip --target node18-linux-arm64 --output "binaries/flight-dispatcher-${VERSION}-linux-arm64"
          chmod +x binaries/flight-dispatcher-*
          ls -la binaries/

      - name: Compute checksums
        shell: bash
        run: |
          cd binaries
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Upload binaries as artifact
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: binaries/

  create-release:
    name: Create GitHub Release
    needs: build-binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: binaries/

      - name: Read changelog / tag message
        id: tag_info
        run: |
          echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "flight-dispatcher ${{ steps.tag_info.outputs.tag }}"
          body: |
            ## Installation

            ### npx (any platform, Node.js required)
            ```bash
            npx flight-dispatcher
            ```

            ### Standalone binary (no Node.js required)
            **macOS (Apple Silicon)**
            ```bash
            curl -fsSL https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.tag }}/flight-dispatcher-${{ steps.tag_info.outputs.tag }}-macos-arm64 -o flight-dispatcher
            chmod +x flight-dispatcher && sudo mv flight-dispatcher /usr/local/bin/
            ```

            **macOS (Intel)**
            ```bash
            curl -fsSL https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.tag }}/flight-dispatcher-${{ steps.tag_info.outputs.tag }}-macos-x64 -o flight-dispatcher
            chmod +x flight-dispatcher && sudo mv flight-dispatcher /usr/local/bin/
            ```

            **Linux (x64)**
            ```bash
            curl -fsSL https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.tag }}/flight-dispatcher-${{ steps.tag_info.outputs.tag }}-linux-x64 -o flight-dispatcher
            chmod +x flight-dispatcher && sudo mv flight-dispatcher /usr/local/bin/
            ```

            **Windows** — download `flight-dispatcher-${{ steps.tag_info.outputs.tag }}-win-x64.exe` below and add to your PATH.

            ### Homebrew (macOS/Linux)
            ```bash
            brew tap caglarorhan/flight-dispatcher
            brew install flight-dispatcher
            ```

            ### npm (global install)
            ```bash
            npm install -g flight-dispatcher
            ```

            ---

            See `checksums.txt` for SHA256 verification.
          files: |
            binaries/*
          draft: false
          prerelease: false

  update-homebrew:
    name: Update Homebrew Formula
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: binaries/

      - name: Compute SHA256 for macOS arm64
        id: sha
        run: |
          VERSION="${{ github.ref_name }}"
          SHA_ARM=$(sha256sum "binaries/flight-dispatcher-${VERSION}-macos-arm64" | awk '{print $1}')
          SHA_X64=$(sha256sum "binaries/flight-dispatcher-${VERSION}-macos-x64" | awk '{print $1}')
          SHA_LINUX=$(sha256sum "binaries/flight-dispatcher-${VERSION}-linux-x64" | awk '{print $1}')
          echo "macos_arm64=$SHA_ARM" >> $GITHUB_OUTPUT
          echo "macos_x64=$SHA_X64" >> $GITHUB_OUTPUT
          echo "linux_x64=$SHA_LINUX" >> $GITHUB_OUTPUT

      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: caglarorhan/homebrew-flight-dispatcher
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap

      - name: Update formula
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"
          REPO="${{ github.repository }}"
          cat > tap/Formula/flight-dispatcher.rb << EOF
          class FlightDispatcher < Formula
            desc "Zero-install CLI that auto-generates .github/copilot-instructions.md"
            homepage "https://github.com/${REPO}"
            version "${VERSION_NUM}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${REPO}/releases/download/${VERSION}/flight-dispatcher-${VERSION}-macos-arm64"
                sha256 "${{ steps.sha.outputs.macos_arm64 }}"

                def install
                  bin.install "flight-dispatcher-#{version}-macos-arm64" => "flight-dispatcher"
                end
              else
                url "https://github.com/${REPO}/releases/download/${VERSION}/flight-dispatcher-${VERSION}-macos-x64"
                sha256 "${{ steps.sha.outputs.macos_x64 }}"

                def install
                  bin.install "flight-dispatcher-#{version}-macos-x64" => "flight-dispatcher"
                end
              end
            end

            on_linux do
              url "https://github.com/${REPO}/releases/download/${VERSION}/flight-dispatcher-${VERSION}-linux-x64"
              sha256 "${{ steps.sha.outputs.linux_x64 }}"

              def install
                bin.install "flight-dispatcher-#{version}-linux-x64" => "flight-dispatcher"
              end
            end

            test do
              system "#{bin}/flight-dispatcher", "--help"
            end
          end
          EOF

      - name: Commit and push formula update
        run: |
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/flight-dispatcher.rb
          git commit -m "chore: update flight-dispatcher to ${{ github.ref_name }}"
          git push

  update-scoop:
    name: Update Scoop Manifest
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: binaries/

      - name: Compute SHA256 for Windows binary
        id: sha
        run: |
          VERSION="${{ github.ref_name }}"
          SHA_WIN=$(sha256sum "binaries/flight-dispatcher-${VERSION}-win-x64.exe" | awk '{print $1}')
          echo "win_x64=$SHA_WIN" >> $GITHUB_OUTPUT

      - name: Update Scoop manifest and push
        env:
          SCOOP_TOKEN: ${{ secrets.SCOOP_BUCKET_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"
          REPO="${{ github.repository }}"
          WIN_SHA="${{ steps.sha.outputs.win_x64 }}"

          # Clone or init the bucket repo
          git clone "https://x-access-token:${SCOOP_TOKEN}@github.com/caglarorhan/scoop-flight-dispatcher.git" bucket || {
            mkdir -p bucket
            cd bucket
            git init
            git remote add origin "https://x-access-token:${SCOOP_TOKEN}@github.com/caglarorhan/scoop-flight-dispatcher.git"
            cd ..
          }

          cd bucket
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Write the manifest (no indentation — Scoop requires clean JSON)
          cat > flight-dispatcher.json << EOF
          {
            "version": "${VERSION_NUM}",
            "description": "Zero-install CLI that auto-generates .github/copilot-instructions.md",
            "homepage": "https://github.com/${REPO}",
            "license": "MIT",
            "architecture": {
              "64bit": {
                "url": "https://github.com/${REPO}/releases/download/${VERSION}/flight-dispatcher-${VERSION}-win-x64.exe",
                "hash": "${WIN_SHA}",
                "bin": [["flight-dispatcher-${VERSION}-win-x64.exe", "flight-dispatcher"]]
              }
            },
            "checkver": {
              "github": "https://github.com/${REPO}"
            },
            "autoupdate": {
              "architecture": {
                "64bit": {
                  "url": "https://github.com/${REPO}/releases/download/v\$version/flight-dispatcher-v\$version-win-x64.exe",
                  "bin": [["flight-dispatcher-v\$version-win-x64.exe", "flight-dispatcher"]]
                }
              }
            }
          }
          EOF

          git add flight-dispatcher.json
          git commit -m "chore: update flight-dispatcher to ${VERSION}"
          # Push; -u sets upstream for first push on new repo
          git push -u origin HEAD:main
